{% extends 'base.html' %}

{% block content %}
<div class="container mt-2">
    <div class="row">
        <!-- Employee List -->
        <div class="col-md-4">
            <h3>My Employees</h3>
            <ul class="list-group">
                {% for employee in managed_users %}
                <li class="list-group-item list-group-item-action employee-item" data-employee-id="{{ employee.id }}">
                    {{ employee.get_full_name }}
                </li>                
                {% empty %}
                <li class="list-group-item">No employees found.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Requests Table -->
        <div class="col-md-8">
            <h3>Employee Requests</h3>
            <div class="table-responsive scrollable-table">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requests-table-body">
                        <!-- Requests will be loaded here via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
  

<script>
    let currentRequestId = null; // Global variable to store the current request ID
    
    document.addEventListener('DOMContentLoaded', function() {
        const employeeItems = document.querySelectorAll('.employee-item');
        const requestsTableBody = document.getElementById('requests-table-body');
        
        // Event listeners for each employee item
        employeeItems.forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all items
                employeeItems.forEach(i => i.classList.remove('active'));
        
                // Add active class to clicked item
                this.classList.add('active');
        
                const employeeId = this.getAttribute('data-employee-id');
        
                // Fetch requests for the selected employee
                fetch(`/get-employee-requests/${employeeId}/`)
                    .then(response => response.json())
                    .then(data => {
                        // Clear existing content in the table
                        requestsTableBody.innerHTML = '';
        
                        // Sort requests with 'Cancelled' status to the end
                        data.sort((a, b) => {
                            if (a.status === 'Cancelled' && b.status !== 'Cancelled') {
                                return 1;
                            }
                            if (a.status !== 'Cancelled' && b.status === 'Cancelled') {
                                return -1;
                            }
                            return 0;
                        });
        
                        // Display each request in the table
                        data.forEach(request => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${request.leave_type}</td>
                                <td>${request.start_date}</td>
                                <td>${request.end_date}</td>
                                <td>${request.status}</td>
                                <td id="action-buttons-${request.id}"></td>
                            `;
                            requestsTableBody.appendChild(row);
        
                            // Generate and append action buttons
                            const actionButtonsHtml = generateActionButtons(request);
                            const actionButtonsContainer = document.getElementById(`action-buttons-${request.id}`);
                            actionButtonsContainer.innerHTML = actionButtonsHtml;
                        });
                        attachButtonEvents();
                    })
                    .catch(error => console.error('Error:', error));
            });
        });
        
        // Generates action buttons based on request status
        function generateActionButtons(request) {
            let buttons = '';
            if (request.status === 'Pending') {
                buttons += `<button class="btn btn-success btn-sm approve-btn" data-request-id="${request.id}">Approve</button>`;
                buttons += `<button class="btn btn-danger btn-sm deny-btn" data-request-id="${request.id}">Deny</button>`;
            } else if (request.status === 'Approved') {
                buttons += `<button class="btn btn-warning btn-sm cancel-btn" data-request-id="${request.id}">Cancel</button>`;
            } else if (request.status === 'Denied') {
                // Add a delete button for denied requests
                buttons += `<button class="btn btn-danger btn-sm delete-btn" data-request-id="${request.id}">Delete</button>`;
            }
            return buttons;
        }
        
        // Attaches event listeners to action buttons
        function attachButtonEvents() {
            // Approve buttons
            document.querySelectorAll('.approve-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const requestId = this.getAttribute('data-request-id');
                    handleApproval(requestId);
                });
            });
        
            // Deny buttons
            document.querySelectorAll('.deny-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const requestId = this.getAttribute('data-request-id');
                    handleDenial(requestId);
                });
            });
        
            // Delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    currentRequestId = this.getAttribute('data-request-id');
                    // Changed from modal to window as having issues executing order of the javascript when using
                    // a modal due.
                    if (window.confirm("Are you sure you want to delete? Deleted requests cannot be restored.")) {
                        handleDelete(currentRequestId);
                    }
                });
            });
        }
        
        // Handles approval of a request
        function handleApproval(requestId) {
            // AJAX call to approve the request
            fetch(`/approve-leave-request/${requestId}/`, { 
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update the request's status in the table
                    const requestRow = document.querySelector(`button[data-request-id="${requestId}"]`).parentNode.parentNode;
                    requestRow.cells[3].textContent = 'Approved';
                    requestRow.cells[4].innerHTML = `<button class="btn btn-warning btn-sm cancel-btn" data-request-id="${requestId}">Cancel</button>`;
                    attachCancelEvent(requestRow.querySelector('.cancel-btn'));
                }
            });
        }
        
        // Handles denial of a request
        function handleDenial(requestId) {
            // AJAX call to deny the request
            fetch(`/deny-leave-request/${requestId}/`, { 
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ requestId: requestId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update the request's status in the table
                    const requestRow = document.querySelector(`button[data-request-id="${requestId}"]`).parentNode.parentNode;
                    requestRow.cells[3].textContent = 'Denied';
                    requestRow.cells[4].innerHTML = '';
                } else {
                    console.error('Error denying request:', data.message);
                }
            });
        }
        
        // Handles cancellation of an approved request
        function handleCancellation(requestId) {
            // AJAX call to cancel the request
            fetch(`/cancel-leave-request-manage/${requestId}/`, { 
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Update the request's status in the table
                    const requestRow = document.querySelector(`button[data-request-id="${requestId}"]`).parentNode.parentNode;
                    requestRow.cells[3].textContent = 'Cancelled';
                    requestRow.cells[4].innerHTML = '';
                } else {
                    console.error('Error cancelling request:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Handles deletion of a request
        function handleDelete(requestId) {
            fetch(`/delete-leave-request/${requestId}/`, { 
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the request row from the table
                    const requestRow = document.querySelector(`button[data-request-id="${requestId}"]`).parentNode.parentNode;
                    requestRow.remove();
                } else {
                    console.error('Error deleting request:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Retrieves CSRF token from cookie
        function getCsrfToken() {
            return document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1];
        }
    });
    </script>
    {% endblock %}    